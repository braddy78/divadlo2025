<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braddyovic Divadeln√≠ Sez√≥na 2025 (Fixed Dark Mode)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;
            --card-bg: #131318;
            --input-bg: #1f1f26;
            --text-main: #e4e4e7;
            --accent-pink: #f43f5e;
            --accent-cyan: #06b6d4;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --border-color: #27272a;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            padding-bottom: 80px;
        }

        h1, h2, h3, h4 { font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Header */
        .header-section {
            background: radial-gradient(circle at top, #1e1b4b 0%, #09090b 100%);
            padding: 40px 0;
            border-bottom: 3px solid var(--accent-cyan);
            box-shadow: 0 0 50px rgba(6, 182, 212, 0.2);
            margin-bottom: 30px;
        }

        .glitch-text {
            font-size: 2.5rem;
            color: white;
            text-shadow: 2px 2px 0px var(--accent-purple);
        }

        /* Stats Cards */
        .stats-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .stats-card:hover { 
            transform: translateY(-5px); 
            border-color: var(--accent-pink);
            box-shadow: 0 10px 25px rgba(244, 63, 94, 0.1);
        }
        .stats-number {
            font-size: 2.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats-label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.9; font-weight: 600; }

        /* Charts */
        .chart-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .chart-title { color: var(--accent-yellow); font-size: 1rem; margin-bottom: 15px; border-left: 3px solid var(--accent-pink); padding-left: 10px; }

        /* Filters */
        .filter-bar {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px 12px 0 0;
            padding: 15px;
            margin-bottom: 0;
        }
        .form-control, .form-select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            font-size: 0.9rem;
        }
        .form-control:focus, .form-select:focus {
            background-color: #272730;
            color: white;
            border-color: var(--accent-cyan);
            box-shadow: none;
        }

        /* TABLE FIXES - AGGRESSIVE DARK MODE */
        .table-container {
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            background-color: var(--card-bg);
        }
        
        .table-scroll {
            overflow-y: auto;
            max-height: 600px;
        }

        /* Force override Bootstrap variables for tables */
        .table {
            --bs-table-bg: var(--card-bg);
            --bs-table-color: var(--text-main);
            --bs-table-hover-bg: #27272a;
            --bs-table-hover-color: white;
            margin-bottom: 0;
            background-color: var(--card-bg);
            color: var(--text-main);
        }

        /* Direct targeting of elements to ensure black background */
        .table th, .table td {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        /* Header styling */
        .table thead th {
            background-color: #000000 !important; /* Total black header */
            color: var(--accent-cyan) !important;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Hover effect - must use !important to override the direct targeting above */
        .table tbody tr:hover td {
            background-color: #1f1f26 !important; /* Slightly lighter black */
            color: white !important;
            cursor: pointer;
        }

        /* Badges */
        .badge-genre { background: rgba(139, 92, 246, 0.15); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
        .badge-city { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
        
        /* Cancelled row styling */
        .cancelled-row td { 
            text-decoration: line-through; 
            opacity: 0.6; 
            color: #f43f5e !important; 
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }
    </style>
</head>
<body>

<div class="header-section text-center">
    <div class="container">
        <h1 class="glitch-text">Braddyovic Divadeln√≠ Sez√≥na 2025</h1>
        <p class="lead text-muted mt-2" style="color: var(--accent-cyan) !important;">
            Dramaturgick√Ω profil 2025: Audit odehran√Ωch titul≈Ø, soubor≈Ø a region√°ln√≠ch v√Ωjezd≈Ø.
        </p>
    </div>
</div>

<div class="container">
    
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="statTotal">0</div>
                <div class="stats-label">üé´ Celkov√Ω poƒçet zhl√©dnut√≠</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="statTheatres">0</div>
                <div class="stats-label">üé≠ Unik√°tn√≠ch soubor≈Ø</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="statCities">0</div>
                <div class="stats-label">üó∫Ô∏è Nav≈°t√≠ven√Ωch mƒõst</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="statRepeats">0</div>
                <div class="stats-label">üîÑ Guilty Pleasures (N√°vraty)</div>
            </div>
        </div>
    </div>


    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-card" style="padding: 14px 18px;">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                    <div>
                        <div class="text-white fw-bold">üî• Nejn√°roƒçnƒõj≈°√≠ t√Ωden</div>
                        <div class="text-muted small" id="busiestWeekText">‚Äî</div>
                    </div>
                    <div class="text-muted small">Mƒõ≈ôeno poƒçtem p≈ôedstaven√≠ Po‚ÄìNe</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="chart-card">
                <h5 class="chart-title">üìà EKG Sez√≥ny (Mƒõs√≠ƒçn√≠ aktivita)</h5>
                <div style="height: 250px;"><canvas id="chartMonthly"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-card">
                <h5 class="chart-title">üìç Geografie: Praha vs. Regiony</h5>
                <div style="height: 250px;"><canvas id="chartLocation"></canvas></div>
            </div>
        </div>
    </div>

    
    <div class="row">
        <div class="col-lg-4">
            <div class="chart-card">
                <h5 class="chart-title">üèÜ Top 10 Soubor≈Ø</h5>
                <div style="height: 320px;"><canvas id="chartTheatres"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-card">
                <h5 class="chart-title">üîÅ Top 10 Repr√≠zovan√Ωch p≈ôedstaven√≠</h5>
                <div style="height: 320px;"><canvas id="chartRepeats"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-card">
                <h5 class="chart-title">‚≠ê Distribuce hodnocen√≠</h5>
                <div style="height: 320px;"><canvas id="chartRatings"></canvas></div>
            </div>
        </div>
    </div>


    <div class="row" id="dataSection">
        <div class="col-12">
            <div class="filter-bar">
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label text-white-50">üîç Hledat n√°zev</label>
                        <input type="text" id="filterTitle" class="form-control" placeholder="Nap≈ô. Peer Gynt...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white-50">üé≠ Soubor</label>
                        <select id="filterTheatre" class="form-select"><option value="">V≈°e</option></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white-50">üìç Mƒõsto/M√≠sto</label>
                        <select id="filterCity" class="form-select"><option value="">V≈°e</option></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white-50">üß† ≈Ω√°nr</label>
                        <select id="filterGenre" class="form-select"><option value="">V≈°e</option></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white-50">üìÖ Mƒõs√≠c</label>
                        <select id="filterMonth" class="form-select">
                            <option value="">V≈°e</option>
                            <option value="0">Leden</option><option value="1">√önor</option>
                            <option value="2">B≈ôezen</option><option value="3">Duben</option>
                            <option value="4">Kvƒõten</option><option value="5">ƒåerven</option>
                            <option value="6">ƒåervenec</option><option value="7">Srpen</option>
                            <option value="8">Z√°≈ô√≠</option><option value="9">≈ò√≠jen</option>
                            <option value="10">Listopad</option><option value="11">Prosinec</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-info w-100" onclick="resetFilters()">Reset</button>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-scroll">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 100px;">Datum</th>
                                <th>N√°zev p≈ôedstaven√≠</th>
                                <th>Soubor</th>
                                <th>M√≠sto / Divadlo</th>
                                <th>Mƒõsto</th>
                                <th>≈Ω√°nr</th>
                                <th style="width: 110px;">Hodnocen√≠</th>
                                <th style="width: 120px;">Koment√°≈ô</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                </div>
                <div class="p-2 text-center text-muted small border-top border-secondary bg-dark">
                    Zobrazeno <span id="visibleCount">0</span> z√°znam≈Ø
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- 1. DATASET --- */
    
    
// Data se naƒç√≠taj√≠ z /data/shows.json (generov√°no automaticky z CSV v repu)
let shows = [];
let rawData = [];

/* --- 2. LOGIKA & ZPRACOV√ÅN√ç --- */
    
    // Konfigurace
    Chart.defaults.font.family = "'Segoe UI', sans-serif";
    Chart.defaults.color = '#a1a1aa';
    Chart.defaults.borderColor = '#27272a';
    const months = ["Leden", "√önor", "B≈ôezen", "Duben", "Kvƒõten", "ƒåerven", "ƒåervenec", "Srpen", "Z√°≈ô√≠", "≈ò√≠jen", "Listopad", "Prosinec"];
    const days = ["Ne", "Po", "√öt", "St", "ƒåt", "P√°", "So"];

    // Glob√°ln√≠ stav filtru
    let filters = { title: "", theatre: "", city: "", genre: "", month: "" };

    async function loadShows() {
        const url = new URL('data/shows.json', window.location.href).toString();
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Nepoda≈ôilo se naƒç√≠st data (${res.status}) z ${url}`);
        const json = await res.json();

        // Podporovan√© form√°ty:
        // 1) { shows: [ {date,title,theatre,place,city,genres,rating,comment,...} ] }
        // 2) [ { ... } ]  (p≈ô√≠mo pole)
        // 3) { rawData: [ [date,title,theatre,place,city,genre], ... ] }  (legacy)
        if (Array.isArray(json)) {
            shows = json;
            return;
        }
        if (Array.isArray(json?.shows)) {
            shows = json.shows;
            return;
        }
        if (Array.isArray(json?.rawData)) {
            shows = json.rawData.map(r => ({
                date: r[0],
                title: r[1],
                theatre: r[2],
                place: r[3],
                city: r[4] || '',
                host: false,
                removed: false,
                genres: String(r[5] || '').split(/[;|,]/).map(x=>x.trim()).filter(Boolean),
                rating: null,
                comment: ''
            }));
            return;
        }
        shows = [];
    }


    // Parsery
    
    // Parsery
    function parseDate(str) {
        // oƒçek√°v√° "DD.MM.YYYY"
        const p = String(str).trim().split('.');
        const dd = parseInt(p[0], 10);
        const mm = parseInt(p[1], 10) - 1;
        const yyyy = parseInt(p[2], 10);
        return new Date(yyyy, mm, dd);
    }

    function getCity(showOrRow) {
        // show objekt (preferov√°no)
        if (showOrRow && typeof showOrRow === 'object' && !Array.isArray(showOrRow)) {
            if (showOrRow.city && showOrRow.city.trim()) return showOrRow.city.trim();

            const place = (showOrRow.place || "");
            // Heuristika pro hostov√°n√≠ v Praze, kdy≈æ mƒõsto nen√≠ vyplnƒõn√©
            if (place.includes("host") || place.includes("ARCHA") || place.includes("Dlouh√©") || place.includes("Palmovk") || place.includes("Rokoko")) return "Praha";
            return "Praha";
        }

        // fallback pro p≈Øvodn√≠ ≈ô√°dek pole
        const row = showOrRow;
        if (row && row[4]) return row[4];
        if (row && row[3] && (row[3].includes("host") || row[3].includes("ARCHA") || row[3].includes("Dlouh√©") || row[3].includes("Palmovk") || row[3].includes("Rokoko"))) return "Praha";
        return "Praha";
    }

    // Inicializace dat pro grafy
    let processedData = [];
    
    
async function initData() {
        await loadShows();

        processedData = (shows || []).map((s, idx) => {
            const dateObj = parseDate(s.date);
            const genresArr = Array.isArray(s.genres) ? s.genres : (s.genre ? [s.genre] : []);
            const cleanGenres = genresArr.map(g => String(g || '').trim()).filter(Boolean);
            const primaryGenre = cleanGenres[0] || '';

            const ratingVal = (s.rating === null || s.rating === undefined || s.rating === '') ? null : Number(s.rating);

            return {
                __idx: idx,
                rawDate: s.date,
                date: dateObj,
                title: s.title || '',
                theatre: s.theatre || '',
                place: s.place || '',
                city: getCity(s),
                genres: cleanGenres,
                genre: primaryGenre,
                host: !!s.host,
                removed: !!s.removed,
                rating: (ratingVal !== null && !Number.isNaN(ratingVal)) ? ratingVal : null,
                comment: s.comment || '',
                monthIdx: dateObj.getMonth(),
                dayIdx: dateObj.getDay()
            };
        });

        populateSelects();
        updateDashboard();
    }

    function populateSelects() {
        const getUnique = (key) => [...new Set(processedData.map(d => d[key]).filter(Boolean))].sort();

        const theatreSel = document.getElementById('filterTheatre');
        theatreSel.length = 1; // keep "V≈°e"
        getUnique('theatre').forEach(t => theatreSel.add(new Option(t, t)));

        const citySel = document.getElementById('filterCity');
        citySel.length = 1;
        getUnique('city').forEach(c => citySel.add(new Option(c, c)));

        // ≈æ√°nry: z d.genres (multi)
        const allGenres = [...new Set(processedData.flatMap(d => d.genres || []))].sort();
        const genreSel = document.getElementById('filterGenre');
        genreSel.length = 1;
        allGenres.forEach(g => genreSel.add(new Option(g, g)));
    }


    /* --- 3. RENDEROV√ÅN√ç --- */

    function updateDashboard() {
        const filtered = processedData.filter(d => {
            const mMatch = filters.month === "" || d.monthIdx == filters.month;
            const tMatch = d.title.toLowerCase().includes(filters.title.toLowerCase());
            const thMatch = filters.theatre === "" || d.theatre === filters.theatre;
            const cMatch = filters.city === "" || d.city === filters.city;
            const gMatch = filters.genre === "" || (d.genres || []).includes(filters.genre);
            return mMatch && tMatch && thMatch && cMatch && gMatch;
        });

        updateStats(filtered);
        renderCharts(filtered);
        renderTable(filtered);
    }

    
function updateStats(data) {
        document.getElementById('statTotal').innerText = data.length;
        document.getElementById('statTheatres').innerText = new Set(data.map(d=>d.theatre)).size;
        document.getElementById('statCities').innerText = new Set(data.map(d=>d.city)).size;

        // Repr√≠zy logika
        const counts = {};
        data.forEach(d => counts[d.title] = (counts[d.title]||0)+1);
        let repeats = 0;
        Object.values(counts).forEach(c => { if(c>1) repeats += (c-1); });
        document.getElementById('statRepeats').innerText = repeats;

        // Nejn√°roƒçnƒõj≈°√≠ t√Ωden (Po‚ÄìNe)
        const startOfWeekMonday = (dt) => {
            const d = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
            const day = (d.getDay() + 6) % 7; // Po=0 ... Ne=6
            d.setDate(d.getDate() - day);
            d.setHours(0,0,0,0);
            return d;
        };

        const key = (d) => d.toISOString().slice(0,10);
        const weekCounts = {};
        data.forEach(item => {
            const w = startOfWeekMonday(item.date);
            const k = key(w);
            weekCounts[k] = (weekCounts[k] || 0) + 1;
        });

        let bestK = null;
        let bestV = 0;
        Object.entries(weekCounts).forEach(([k,v]) => {
            if (v > bestV) { bestV = v; bestK = k; }
        });

        const el = document.getElementById('busiestWeekText');
        if (el) {
            if (!bestK) {
                el.textContent = "‚Äî";
            } else {
                const monday = new Date(bestK);
                const sunday = new Date(monday); sunday.setDate(sunday.getDate() + 6);
                const fmt = (d) => String(d.getDate()).padStart(2,'0') + "." + String(d.getMonth()+1).padStart(2,'0') + "." + d.getFullYear();
                el.textContent = `${fmt(monday)} ‚Äì ${fmt(sunday)} ‚Ä¢ ${bestV} p≈ôedstaven√≠`;
            }
        }
    }


    // Instance graf≈Ø
    let charts = {};

    
function renderCharts(data) {
        // Agregace
        const countBy = (keyFn) => {
            const acc = {};
            data.forEach(d => { const k = keyFn(d); acc[k] = (acc[k]||0)+1; });
            return acc;
        };

        // 1) Mƒõs√≠ƒçn√≠ aktivita
        const monthly = new Array(12).fill(0);
        data.forEach(d => monthly[d.monthIdx]++);
        createOrUpdateChart('chartMonthly', 'line', months, monthly, '#06b6d4', {fill: true});

        // 2) Praha vs regiony + dal≈°√≠ mƒõsta
        const cityRaw = countBy(d => d.city);
        const prahaVal = cityRaw["Praha"] || 0;
        delete cityRaw["Praha"];
        const sortedCities = Object.entries(cityRaw).sort((a,b)=>b[1]-a[1]);
        const locLabels = ["Praha (V≈°e)", ...sortedCities.map(x=>x[0])];
        const locData = [prahaVal, ...sortedCities.map(x=>x[1])];
        const locColors = ['#06b6d4', '#f59e0b', '#f43f5e', '#8b5cf6', '#10b981', '#ff8c00'];
        createOrUpdateChart('chartLocation', 'bar', locLabels, locData, locColors);

        // 3) Top 10 soubor≈Ø
        const theatreRaw = Object.entries(countBy(d=>d.theatre))
            .sort((a,b)=>b[1]-a[1])
            .slice(0,10);
        createOrUpdateChart(
            'chartTheatres',
            'bar',
            theatreRaw.map(x=>x[0]),
            theatreRaw.map(x=>x[1]),
            '#f43f5e',
            { indexAxis: 'y' }
        );

        // 4) Top 10 repr√≠zovan√Ωch p≈ôedstaven√≠ (n√°zev + poƒçet)
        const titleCounts = countBy(d=>d.title);
        const repeatsRaw = Object.entries(titleCounts)
            .filter(([,v]) => v > 1)
            .sort((a,b)=>b[1]-a[1])
            .slice(0,10);

        createOrUpdateChart(
            'chartRepeats',
            'bar',
            repeatsRaw.length ? repeatsRaw.map(x=>x[0]) : ["‚Äî"],
            repeatsRaw.length ? repeatsRaw.map(x=>x[1]) : [0],
            '#8b5cf6',
            { indexAxis: 'y' }
        );

        // 5) Distribuce hodnocen√≠ 0‚Äì100 (po 10 bodech)
        const ratings = data
            .map(d => d.rating)
            .filter(v => v !== null && v !== undefined && !Number.isNaN(v));

        const bins = new Array(10).fill(0);
        ratings.forEach(r => {
            const rr = Math.max(0, Math.min(100, Number(r)));
            const idx = Math.min(9, Math.floor(rr / 10));
            bins[idx] += 1;
        });

        const labels = ["0‚Äì9","10‚Äì19","20‚Äì29","30‚Äì39","40‚Äì49","50‚Äì59","60‚Äì69","70‚Äì79","80‚Äì89","90‚Äì100"];
        createOrUpdateChart('chartRatings', 'bar', labels, bins, '#f59e0b');
    }


    function createOrUpdateChart(id, type, labels, data, colors, extraOpts = {}) {
        const ctx = document.getElementById(id).getContext('2d');
        const bgColors = Array.isArray(colors) ? colors : (type === 'line' ? 'rgba(6, 182, 212, 0.2)' : colors);
        const borderCol = Array.isArray(colors) ? colors[0] : colors;

        if (charts[id]) {
            charts[id].data.labels = labels;
            charts[id].data.datasets[0].data = data;
            charts[id].data.datasets[0].backgroundColor = bgColors;
            charts[id].update();
        } else {
            charts[id] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Poƒçet',
                        data: data,
                        backgroundColor: bgColors,
                        borderColor: type==='line'?colors:'transparent',
                        borderWidth: 2,
                        borderRadius: 4,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: type === 'doughnut' ? {} : {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, grid: { color: '#27272a' } }
                    },
                    onClick: (e, el) => handleChartClick(el, id, labels),
                    ...extraOpts
                }
            });
        }
    }

    // Interakce graf≈Ø -> Filtry
    
function handleChartClick(elements, chartId, labels) {
        if (!elements.length) return;
        const idx = elements[0].index;
        const label = labels[idx];

        if(chartId === 'chartMonthly') {
            document.getElementById('filterMonth').value = idx; 
        } else if(chartId === 'chartTheatres') {
            document.getElementById('filterTheatre').value = label;
        } else if(chartId === 'chartRepeats') {
            document.getElementById('filterTitle').value = label === "‚Äî" ? "" : label;
        } else if(chartId === 'chartLocation') {
             if(label === "Praha (V≈°e)") document.getElementById('filterCity').value = "Praha";
             else document.getElementById('filterCity').value = label;
        }

        applyFilters(); // Trigger reload
    }
        
        applyFilters(); // Trigger reload
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        // Se≈ôadit chronologicky
        data.sort((a,b) => a.date - b.date);

        data.forEach(row => {
            const tr = document.createElement('tr');

            // Stylov√°n√≠ sta≈æen√Ωch / zru≈°en√Ωch kus≈Ø (row.removed)
            if (row.removed) tr.classList.add('cancelled-row');

            const cityBadge = row.city && row.city !== "Praha"
                ? `<span class="badge badge-city ms-2">${row.city}</span>`
                : '';

            const ratingText = (row.rating === null || row.rating === undefined || Number.isNaN(row.rating))
                ? `<span class="opacity-50">‚Äî</span>`
                : `<span class="text-white fw-bold">${Math.round(row.rating)}&nbsp;%</span>`;

            const hasComment = row.comment && row.comment.trim().length > 0;
            const commentBtn = hasComment
                ? `<button class="btn btn-sm btn-outline-warning" onclick="openCommentModal(${row.__idx})">Koment√°≈ô</button>`
                : `<button class="btn btn-sm btn-outline-secondary" disabled>‚Äî</button>`;

            const genreLabel = row.genre ? row.genre : (row.genres && row.genres.length ? row.genres[0] : "");
            const genreBadges = (row.genres && row.genres.length)
                ? row.genres.map(g => `<span class="badge badge-genre me-1">${g}</span>`).join('')
                : (genreLabel ? `<span class="badge badge-genre">${genreLabel}</span>` : `<span class="opacity-50">‚Äî</span>`);

            const removedTag = row.removed ? ` <span class="badge bg-danger ms-1">STA≈ΩENO</span>` : '';

            tr.innerHTML = `
                <td><span class="text-white fw-bold">${row.rawDate || row.raw?.[0] || ''}</span></td>
                <td class="text-white">${row.title}${removedTag}</td>
                <td>${row.theatre}</td>
                <td class="small text-muted">${row.place}</td>
                <td>${cityBadge || '<span class="opacity-50">Praha</span>'}</td>
                <td>${genreBadges}</td>
                <td>${ratingText}</td>
                <td>${commentBtn}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('visibleCount').innerText = data.length;
    }

    /* --- 4. OVL√ÅD√ÅN√ç --- */


    // Koment√°≈ôe: modal
    function openCommentModal(idx) {
        const row = processedData.find(d => d.__idx === idx);
        if (!row) return;

        const titleEl = document.getElementById('commentModalTitle');
        const bodyEl = document.getElementById('commentModalBody');
        const metaEl = document.getElementById('commentModalMeta');
        const ratingEl = document.getElementById('commentModalRating');

        titleEl.textContent = row.title || 'Koment√°≈ô';
        metaEl.textContent = `${row.theatre || ''} ‚Ä¢ ${row.place || ''} ‚Ä¢ ${row.rawDate || ''}`.replace(/\s+‚Ä¢\s+‚Ä¢/g,' ‚Ä¢').trim();

        if (row.rating !== null && row.rating !== undefined && !Number.isNaN(row.rating)) {
            ratingEl.style.display = '';
            ratingEl.textContent = `${Math.round(row.rating)} %`;
        } else {
            ratingEl.style.display = 'none';
        }

        bodyEl.textContent = (row.comment && row.comment.trim()) ? row.comment.trim() : '‚Äî';

        const modalEl = document.getElementById('commentModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }

    function applyFilters() {
        filters.title = document.getElementById('filterTitle').value;
        filters.theatre = document.getElementById('filterTheatre').value;
        filters.city = document.getElementById('filterCity').value;
        filters.genre = document.getElementById('filterGenre').value;
        filters.month = document.getElementById('filterMonth').value;
        
        if(filters.title !== "") {
            document.getElementById("dataSection").scrollIntoView({ behavior: 'smooth' });
        }
        updateDashboard();
    }

    function resetFilters() {
        document.getElementById('filterTitle').value = "";
        document.getElementById('filterTheatre').value = "";
        document.getElementById('filterCity').value = "";
        document.getElementById('filterGenre').value = "";
        document.getElementById('filterMonth').value = "";
        applyFilters();
    }

    // Listeners
    ['filterTitle', 'filterTheatre', 'filterCity', 'filterGenre', 'filterMonth'].forEach(id => {
        document.getElementById(id).addEventListener('change', applyFilters);
        if (id === 'filterTitle') {
             document.getElementById(id).addEventListener('input', applyFilters);
        }
    });

    // Start
    initData().catch(console.error);

</script>

<!-- Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-main);">
      <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
        <h5 class="modal-title" id="commentModalTitle">Koment√°≈ô</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
          <span class="badge bg-info text-dark" id="commentModalRating" style="display:none;"></span>
          <span class="badge bg-secondary" id="commentModalMeta"></span>
        </div>
        <div id="commentModalBody" class="lh-lg" style="white-space: pre-wrap;"></div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
        <button type="button" class="btn btn-outline-info" data-bs-dismiss="modal">Zav≈ô√≠t</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>